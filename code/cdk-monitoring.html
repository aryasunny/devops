<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CDK – Monitoring Stack</title>
    <style>
      body {
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: #0d1117;
        color: #e6edf3;
        padding: 40px;
        line-height: 1.6;
      }
      pre {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
        font-size: 14px;
        color: #d1d5da;
      }
      h1,
      h2 {
        color: #58a6ff;
      }
      a {
        color: #8b949e;
        text-decoration: none;
      }
      a:hover {
        color: #58a6ff;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 12px;
        border: 1px solid #30363d;
        border-radius: 6px;
        background-color: #21262d;
      }
      .back-link:hover {
        background-color: #30363d;
      }
    </style>
  </head>
  <body>
    <a class="back-link" href="#" onclick="window.history.back(); return false;"
      >← Back to slides</a
    >
    <h1>CDK: Monitoring as Code with Team Self-Service</h1>
    <p>
      Complete monitoring infrastructure with team configuration interfaces,
      PR-driven deployment, and standardized patterns.
    </p>

    <h2>Team Configuration Interface</h2>
    <pre><code>// teams/email-service/monitoring-config.ts
export interface MonitoringConfig {
  thresholds: {
    errorRate: number;      // %
    latency: number;        // ms
    bounceRate: number;     // %
    dlqDepth: number;       // count
  };
  notifications: {
    slack: string;
    pagerDuty: string;
  };
  dashboard: {
    widgets: string[];
    refreshRate: number;    // seconds
  };
}

export const emailServiceConfig: MonitoringConfig = {
  thresholds: {
    errorRate: 2,
    latency: 5000,
    bounceRate: 2,
    dlqDepth: 10,
  },
  notifications: {
    slack: '#email-alerts',
    pagerDuty: 'email-oncall'
  },
  dashboard: {
    widgets: ['success-rate', 'latency', 'ses-metrics', 'dlq-depth'],
    refreshRate: 300
  }
};
</code></pre>

    <h2>CDK Monitoring Stack</h2>
    <pre><code>// infrastructure/monitoring-stack.ts
import { Stack, Duration, RemovalPolicy } from "aws-cdk-lib";
import { 
  Alarm, Metric, ComparisonOperator, Dashboard, 
  GraphWidget, SingleValueWidget, LogQueryWidget 
} from "aws-cdk-lib/aws-cloudwatch";
import { Topic, Subscription, SubscriptionProtocol } from "aws-cdk-lib/aws-sns";
import { SnsAction } from "aws-cdk-lib/aws-cloudwatch-actions";
import { LogGroup, RetentionDays } from "aws-cdk-lib/aws-logs";
import { Rule, EventPattern } from "aws-cdk-lib/aws-events";
import { MonitoringConfig } from '../teams/email-service/monitoring-config';

export class MonitoringStack extends Stack {
  constructor(scope: Construct, id: string, config: MonitoringConfig) {
    super(scope, id);

    // SNS Topics for alerting
    const criticalAlerts = new Topic(this, "CriticalAlerts", {
      displayName: "Critical Email Service Alerts"
    });
    
    const warningAlerts = new Topic(this, "WarningAlerts", {
      displayName: "Warning Email Service Alerts"
    });

    // Slack integration
    new Subscription(this, "SlackIntegration", {
      topic: criticalAlerts,
      protocol: SubscriptionProtocol.HTTPS,
      endpoint: `https://hooks.slack.com/services/webhook/${config.notifications.slack}`
    });

    // CloudWatch Log Groups
    const apiLogGroup = new LogGroup(this, "EmailApiLogs", {
      logGroupName: "/aws/lambda/email-api",
      retention: RetentionDays.ONE_WEEK,
      removalPolicy: RemovalPolicy.DESTROY
    });

    // Custom Metrics from Logs
    const successRateMetric = apiLogGroup.addMetricFilter("SuccessRate", {
      filterPattern: "[timestamp, requestId, level=\"INFO\", message=\"EMAIL_SENT\"]",
      metricNamespace: "EmailService",
      metricName: "SuccessfulEmails",
      metricValue: "1"
    });

    // Alarms with team-specific thresholds
    const errorRateAlarm = new Alarm(this, "ErrorRateAlarm", {
      metric: new Metric({
        namespace: "AWS/Lambda",
        metricName: "Errors",
        dimensionsMap: { FunctionName: "email-processor" },
        statistic: "Sum",
        period: Duration.minutes(5)
      }),
      threshold: config.thresholds.errorRate,
      evaluationPeriods: 2,
      comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
      alarmDescription: `Email service error rate > ${config.thresholds.errorRate}%`,
      treatMissingData: TreatMissingData.NOT_BREACHING
    });
    errorRateAlarm.addAlarmAction(new SnsAction(criticalAlerts));

    const latencyAlarm = new Alarm(this, "LatencyAlarm", {
      metric: new Metric({
        namespace: "AWS/Lambda",
        metricName: "Duration",
        dimensionsMap: { FunctionName: "email-processor" },
        statistic: "Average",
        period: Duration.minutes(5)
      }),
      threshold: config.thresholds.latency,
      evaluationPeriods: 3,
      comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
      alarmDescription: `Email processing latency > ${config.thresholds.latency}ms`
    });
    latencyAlarm.addAlarmAction(new SnsAction(warningAlerts));

    // SES Bounce Rate Alarm
    const bounceRateAlarm = new Alarm(this, "SESBounceRateAlarm", {
      metric: new Metric({
        namespace: "AWS/SES",
        metricName: "Reputation.BounceRate",
        statistic: "Average",
        period: Duration.minutes(15)
      }),
      threshold: config.thresholds.bounceRate / 100, // Convert % to decimal
      evaluationPeriods: 2,
      comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
      alarmDescription: `SES bounce rate > ${config.thresholds.bounceRate}%`
    });
    bounceRateAlarm.addAlarmAction(new SnsAction(criticalAlerts));

    // DLQ Depth Alarm
    const dlqAlarm = new Alarm(this, "DLQDepthAlarm", {
      metric: new Metric({
        namespace: "AWS/SQS",
        metricName: "ApproximateNumberOfVisibleMessages",
        dimensionsMap: { QueueName: "email-dlq" },
        statistic: "Maximum",
        period: Duration.minutes(5)
      }),
      threshold: config.thresholds.dlqDepth,
      evaluationPeriods: 1,
      comparisonOperator: ComparisonOperator.GREATER_THAN_THRESHOLD,
      alarmDescription: `DLQ depth > ${config.thresholds.dlqDepth} messages`
    });
    dlqAlarm.addAlarmAction(new SnsAction(warningAlerts));

    // Comprehensive Dashboard
    const dashboard = new Dashboard(this, "EmailServiceDashboard", {
      dashboardName: "EmailService-Operations",
      defaultInterval: Duration.minutes(config.dashboard.refreshRate / 60)
    });

    // Dashboard Widgets
    dashboard.addWidgets(
      new GraphWidget({
        title: "Email Success Rate",
        left: [successRateMetric.metric()],
        width: 12,
        height: 6
      }),
      new GraphWidget({
        title: "Processing Latency (P50, P95, P99)",
        left: [
          new Metric({
            namespace: "AWS/Lambda",
            metricName: "Duration",
            dimensionsMap: { FunctionName: "email-processor" },
            statistic: "p50"
          }),
          new Metric({
            namespace: "AWS/Lambda", 
            metricName: "Duration",
            dimensionsMap: { FunctionName: "email-processor" },
            statistic: "p95"
          }),
          new Metric({
            namespace: "AWS/Lambda",
            metricName: "Duration", 
            dimensionsMap: { FunctionName: "email-processor" },
            statistic: "p99"
          })
        ],
        width: 12,
        height: 6
      }),
      new SingleValueWidget({
        title: "SES Reputation",
        metrics: [
          new Metric({
            namespace: "AWS/SES",
            metricName: "Reputation.BounceRate"
          }),
          new Metric({
            namespace: "AWS/SES", 
            metricName: "Reputation.ComplaintRate"
          })
        ],
        width: 12,
        height: 6
      })
    );

    // EventBridge Rule for deployment notifications
    new Rule(this, "DeploymentNotifications", {
      eventPattern: {
        source: ["aws.codepipeline"],
        detailType: ["CodePipeline Pipeline Execution State Change"],
        detail: {
          pipeline: ["email-service-pipeline"],
          state: ["FAILED", "SUCCEEDED"]
        }
      } as EventPattern,
      targets: [new SnsTopic(warningAlerts)]
    });
  }
}
</code></pre>
  </body>
</html>
