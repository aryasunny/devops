<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GitHub Actions Workflow – Monitoring Deployment</title>
    <style>
      body {
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: #0d1117;
        color: #e6edf3;
        padding: 40px;
        line-height: 1.6;
      }
      pre {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
        font-size: 14px;
        color: #d1d5da;
      }
      h1,
      h2 {
        color: #58a6ff;
      }
      a {
        color: #8b949e;
        text-decoration: none;
      }
      a:hover {
        color: #58a6ff;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 12px;
        border: 1px solid #30363d;
        border-radius: 6px;
        background-color: #21262d;
      }
      .back-link:hover {
        background-color: #30363d;
      }
    </style>
  </head>
  <body>
    <a class="back-link" href="#"
      onclick="
        // Try to go back in history first (for local development)
        if (document.referrer && document.referrer.includes(window.location.origin)) {
          window.history.back();
        } else {
          // Fallback for GitHub Pages or direct access
          window.location.href = '../' + '?v=2025-01-07&t=' + Date.now();
        }
        return false;
      "
      >← Back to slides</a
    >
    <h1>🚀 PR-Driven Monitoring Deployment with Environment Promotion</h1>
    <p>
      Complete CI/CD pipeline for monitoring infrastructure with team
      configuration validation, PR reviews, environment promotion (dev → staging
      → prod), and rollback capabilities.
    </p>
    
    <!-- Visual Deployment Flow -->
    <div style="background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 20px; margin: 20px 0;">
      <h3 style="color: #58a6ff; margin-top: 0;">� Shift-Left Pipeline: PR-First Quality Gates</h3>
      
      <!-- PR Validation Phase -->
      <div style="background: rgba(255,149,0,0.1); border: 1px solid rgba(255,149,0,0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
        <h4 style="color: #ff9500; margin: 0 0 15px 0; font-size: 16px;">📋 Pull Request Phase - Early Quality Enforcement</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0;">
          
          <div style="text-align: center; background: #0d1117; padding: 12px; border-radius: 6px; border: 1px solid #30363d;">
            <div style="background: #1f6feb; color: white; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-weight: bold; font-size: 14px;">
              🔒 Security Scan
            </div>
            <div style="font-size: 11px; color: #7d8590; line-height: 1.3;">
              • SAST analysis<br/>
              • Dependency scan<br/>
              • Secret detection<br/>
              • License compliance
            </div>
          </div>
          
          <div style="text-align: center; background: #0d1117; padding: 12px; border-radius: 6px; border: 1px solid #30363d;">
            <div style="background: #22c55e; color: white; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-weight: bold; font-size: 14px;">
              ✅ Code Quality
            </div>
            <div style="font-size: 11px; color: #7d8590; line-height: 1.3;">
              • ESLint/Prettier<br/>
              • Unit tests >80%<br/>
              • Complexity check<br/>
              • Type validation
            </div>
          </div>
          
          <div style="text-align: center; background: #0d1117; padding: 12px; border-radius: 6px; border: 1px solid #30363d;">
            <div style="background: #a855f7; color: white; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-weight: bold; font-size: 14px;">
              📋 CDK Validation
            </div>
            <div style="font-size: 11px; color: #7d8590; line-height: 1.3;">
              • CDK synth check<br/>
              • Policy validation<br/>
              • Resource diff<br/>
              • Cost estimation
            </div>
          </div>
          
          <div style="text-align: center; background: #0d1117; padding: 12px; border-radius: 6px; border: 1px solid #30363d;">
            <div style="background: #238636; color: white; padding: 6px 10px; border-radius: 4px; margin-bottom: 8px; font-weight: bold; font-size: 14px;">
              👥 Peer Review
            </div>
            <div style="font-size: 11px; color: #7d8590; line-height: 1.3;">
              • Code review<br/>
              • Architecture check<br/>
              • Security review<br/>
              • Approval required
            </div>
          </div>
          
        </div>
        
        <div style="text-align: center; margin: 15px 0; padding: 10px; background: rgba(34,197,94,0.1); border-radius: 6px; border: 1px solid rgba(34,197,94,0.3);">
          <span style="color: #22c55e; font-weight: bold; font-size: 14px;">✅ All Quality Gates Pass → Merge Approved</span>
        </div>
      </div>
      
      <!-- Post-Merge Deployment Phase -->
      <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
        <h4 style="color: #22c55e; margin: 0 0 15px 0; font-size: 16px;">🚀 Post-Merge Phase - Automated Deployment</h4>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin: 15px 0;">
          
          <div style="text-align: center; flex: 1; min-width: 140px;">
            <div style="background: #ff9500; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-weight: bold;">
              🚀 Deploy Stack
            </div>
            <div style="font-size: 12px; color: #7d8590;">
              CDK deploy<br/>CloudFormation<br/>Resource creation
            </div>
          </div>
          
          <div style="color: #58a6ff; font-size: 20px; font-weight: bold;">→</div>
          
          <div style="text-align: center; flex: 1; min-width: 140px;">
            <div style="background: #7c3aed; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-weight: bold;">
              🧪 Integration Tests
            </div>
            <div style="font-size: 12px; color: #7d8590;">
              End-to-end<br/>API validation<br/>Smoke tests
            </div>
          </div>
          
          <div style="color: #58a6ff; font-size: 20px; font-weight: bold;">→</div>
          
          <div style="text-align: center; flex: 1; min-width: 140px;">
            <div style="background: #da3633; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-weight: bold;">
              📊 Monitor & Alert
            </div>
            <div style="font-size: 12px; color: #7d8590;">
              Health checks<br/>Metrics validation<br/>Alert setup
            </div>
          </div>
          
        </div>
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background: rgba(255,149,0,0.1); border-left: 3px solid #ff9500; border-radius: 4px;">
        <strong style="color: #ff9500;">Shift-Left Benefits:</strong> 
        <span style="color: #e6edf3;">Early defect detection, Reduced deployment risk, Faster feedback cycles, Quality enforcement, Security by design</span>
      </div>
    </div>

    <h2>🔄 Shift-Left PR Validation Workflow</h2>
    <p style="background: rgba(255,149,0,0.1); padding: 12px; border-radius: 6px; border-left: 4px solid #ff9500; margin: 15px 0;">
      <strong style="color: #ff9500;">Shift-Left Approach:</strong> All quality gates run automatically on PR creation, ensuring issues are caught early in the development cycle before merge.
    </p>
    
    <pre><code name="yaml"># .github/workflows/pr-validation.yml
name: 🔄 Shift-Left PR Validation</code>

on:
  pull_request:
    branches: [main, develop]
    paths: 
      - 'teams/*/monitoring-config.ts'
      - 'infrastructure/**'
      - 'src/**'
      - 'cdk.json'

jobs:
  # Parallel execution for faster feedback ⚡
  security-compliance:
    name: 🔒 Security & Compliance Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning
      
      - name: 🕵️ Secret & Credential Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: 🔍 SAST Code Analysis  
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_TYPESCRIPT_STANDARD: true
          VALIDATE_YAML: true
          VALIDATE_JSON: true
      
      - name: 📋 Dependency Vulnerability Scan
        run: |
          npm audit --audit-level=moderate
          # Block on high/critical vulnerabilities
          npm audit --audit-level=high

  code-quality:
    name: ✅ Code Quality & Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: 🧹 Lint & Format Check
        run: |
          # TypeScript compilation
          npm run build
          
          # ESLint with security rules
          npm run lint
          
          # Prettier formatting
          npm run format:check
          
          # Code complexity analysis
          npm run complexity:check

      - name: 🧪 Unit Tests with Coverage
        run: |
          npm run test:unit -- --coverage --threshold=80
          npm run test:integration
          
      - name: 📊 Upload Coverage
        uses: codecov/codecov-action@v3

  infrastructure-validation:
    name: 📋 Infrastructure & Monitoring
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: 🏗️ CDK Synthesis & Validation
        env:
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          # Synthesize all stacks with strict validation
          npx cdk synth --all --strict
          
          # Security and compliance checks
          npx cdk-nag --app 'npx ts-node infrastructure/app.ts'
          
      - name: 📊 Infrastructure Analysis
        run: |
          # Show resource differences
          npx cdk diff --all
          
          # Validate monitoring configurations
          npm run validate:monitoring-config
          
          # Check SLI/SLO thresholds
          npm run validate:sli-slo
          
          # Cost impact estimation
          npm run estimate:cost-impact

      - name: 💬 Comment PR with Analysis
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 📊 Monitoring Changes Preview\n\n\`\`\`diff\n${diff}\n\`\`\``
            });
</code></pre>

    <h2>Environment Promotion Pipeline</h2>
    <pre><code name="yaml"># .github/workflows/deploy-monitoring.yml
name: Deploy Monitoring Infrastructure

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'dev'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials - Dev
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/monitoring-dev-deploy
          aws-region: ap-southeast-2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Dev
        run: |
          npx cdk deploy monitoring-stack-dev \
            --context environment=dev \
            --context team-configs=./teams \
            --require-approval never \
            --outputs-file dev-outputs.json

      - name: Run smoke tests
        run: |
          npm run test:smoke -- --env dev
          # Verify alarms are created, dashboards accessible

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-deployment
          path: |
            dev-outputs.json
            cdk.out/

  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    needs: deploy-dev
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials - Staging
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::789012345678:role/monitoring-staging-deploy
          aws-region: ap-southeast-2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Staging
        run: |
          npx cdk deploy monitoring-stack-staging \
            --context environment=staging \
            --context team-configs=./teams \
            --require-approval never

      - name: Integration tests
        run: |
          npm run test:integration -- --env staging
          # Test alarm functionality, dashboard rendering

      - name: Performance validation
        run: |
          npm run test:performance -- --env staging
          # Ensure monitoring doesn't impact app performance

  deploy-prod:
    runs-on: ubuntu-latest
    environment: production
    needs: [deploy-dev, deploy-staging]
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials - Prod
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::345678901234:role/monitoring-prod-deploy
          aws-region: ap-southeast-2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Production
        run: |
          npx cdk deploy monitoring-stack-prod \
            --context environment=prod \
            --context team-configs=./teams \
            --require-approval never

      - name: Verify deployment
        run: |
          npm run verify:prod-deployment
          # Check all alarms are healthy, dashboards load

      - name: Create deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: deployment } = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              description: 'Monitoring stack deployment'
            });

  rollback:
    runs-on: ubuntu-latest
    if: failure()
    environment: production
    steps:
      - name: Notify on-call team
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data '{"text":"🚨 Monitoring deployment failed! Manual intervention required."}'
            
      - name: Auto-rollback to previous version
        run: |
          # Get previous successful deployment
          PREV_SHA=$(git log --format="%H" -n 2 | tail -1)
          echo "Rolling back to $PREV_SHA"
          
          # Trigger rollback deployment
          gh workflow run deploy-monitoring.yml \
            --ref $PREV_SHA \
            --field environment=prod
</code></pre>

    <h2>Team Configuration Validation</h2>
    <pre><code name="yaml"># scripts/validate-configs.js
const fs = require('fs');
const path = require('path');

// Validate team monitoring configurations
const validateConfigs = async () => {
  const teamsDir = path.join(__dirname, '../teams');
  const teams = fs.readdirSync(teamsDir);
  
  for (const team of teams) {
    const configPath = path.join(teamsDir, team, 'monitoring-config.ts');
    if (fs.existsSync(configPath)) {
      const config = require(configPath);
      
      // Validate threshold ranges
      if (config.thresholds.errorRate > 10) {
        throw new Error(`${team}: Error rate threshold too high (${config.thresholds.errorRate}% > 10%)`);
      }
      
      if (config.thresholds.latency > 30000) {
        throw new Error(`${team}: Latency threshold too high (${config.thresholds.latency}ms > 30s)`);
      }
      
      // Validate notification endpoints
      if (!config.notifications.slack.startsWith('#')) {
        throw new Error(`${team}: Invalid Slack channel format`);
      }
      
      console.log(`✅ ${team} configuration valid`);
    }
  }
  
  console.log('All team configurations validated successfully!');
};

validateConfigs().catch(console.error);
</code></pre>
  </body>
</html>
